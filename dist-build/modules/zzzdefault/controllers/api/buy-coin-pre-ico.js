var _0xf26b=['coinwallet','buy_pre_ico','Pre-ICO\x20Order','statistics','balance.coin','buycoin','pre_ico_price','buy-pre-ico','__Ini','sendToMember','update-member-transaction','json','catch','./../../../../core/core','./../../../../models/Member','./../../../../models/MemberBalance','./../../../../models/MemberStatistics','./../../../../models/WalletTransaction','./../../../../libraries/LbCoinmarketcap','./../../../../models/MemberBuyICOOrder','./../../../../libraries/LbBuyCoin','moment-timezone','config','index','checkBody','amountRequired','notEmpty','_id','withMessage','amountNotValid','canNotBuyCoinThisTime','then','GetValue','day','valueOf','pre_ico_start_time','getTime','amount','findOne','pre_ico_sold','updateQ','plus','value','member','body','qty','getTicker','BTC','price_usd','findById','balance','minus','coin','create','address','update','totalReceived','totalSend'];(function(_0x1649ad,_0x4e308c){var _0x17be1b=function(_0x257c3b){while(--_0x257c3b){_0x1649ad['push'](_0x1649ad['shift']());}};_0x17be1b(++_0x4e308c);}(_0xf26b,0x169));var _0xbf26=function(_0x41b5f7,_0x588691){_0x41b5f7=_0x41b5f7-0x0;var _0x9fa063=_0xf26b[_0x41b5f7];return _0x9fa063;};'use strict';const core=require(_0xbf26('0x0'));const Member=require(_0xbf26('0x1'));const MemberBalance=require(_0xbf26('0x2'));const MemberStatistics=require(_0xbf26('0x3'));const WalletAddress=require('./../../../../models/WalletAddress');const WalletTransaction=require(_0xbf26('0x4'));const LbCoinmarketcap=require(_0xbf26('0x5'));const SysConfig=require('./../../../../models/SysConfig');const Config=require('./../../../../config/config');const MemberBuyCoin=require('./../../../../models/MemberBuyCoin');const MemberBuyICOOrder=require(_0xbf26('0x6'));const CoinTransaction=require('./../../../../models/CoinTransaction');const LbBuyCoin=require(_0xbf26('0x7'));const Tx=require('./../../../../models/Tx');const moment=require(_0xbf26('0x8'));var bigNumber=require('bignumber.js');bigNumber[_0xbf26('0x9')]({'DECIMAL_PLACES':0x8,'ERRORS':![],'ROUNDING_MODE':0x1});class DefaultApiBuyCoinPreICO extends core{constructor(){super();this[_0xbf26('0xa')]();}[_0xbf26('0xa')](){this['post']('/',(_0x3b437a,_0x4e7f0f)=>{_0x3b437a[_0xbf26('0xb')]('amount',__(_0xbf26('0xc')))[_0xbf26('0xd')]()['BuyBTCAmountPreICO'](_0x3b437a['member'][_0xbf26('0xe')])[_0xbf26('0xf')](__(_0xbf26('0x10')))['buyCoinTimePreICO']()['withMessage'](__(_0xbf26('0x11')));_0x3b437a['asyncValidationErrors']()[_0xbf26('0x12')](()=>{SysConfig[_0xbf26('0x13')](_0x246ee5=>{let _0x340304=moment()['tz'](Config['time'])['startOf'](_0xbf26('0x14'))[_0xbf26('0x15')]();let _0x41de09=_0x340304+_0x246ee5[_0xbf26('0x16')];let _0x50e54e=_0x340304+_0x246ee5['pre_ico_end_time'];let _0x3388f2=new Date()[_0xbf26('0x17')]();let _0x524888=+_0x3b437a['body'][_0xbf26('0x18')];if(_0x3388f2<_0x50e54e&&_0x3388f2>_0x41de09){SysConfig[_0xbf26('0x19')]({'code':_0xbf26('0x1a')},(_0x47659e,_0x110c42)=>{SysConfig[_0xbf26('0x1b')]({'code':_0xbf26('0x1a')},{'value':new bigNumber(_0x524888)[_0xbf26('0x1c')](_0x110c42[_0xbf26('0x1d')])},()=>{});});}else{}MemberBuyCoin['findOne']({'member':_0x3b437a[_0xbf26('0x1e')][_0xbf26('0xe')],'date':_0x340304},(_0x2846c3,_0x2c9e6d)=>{MemberBuyCoin[_0xbf26('0x1b')]({'member':_0x3b437a['member'][_0xbf26('0xe')],'date':_0x340304},{'qty':new bigNumber(_0x3b437a[_0xbf26('0x1f')][_0xbf26('0x18')])[_0xbf26('0x1c')](_0x2c9e6d?_0x2c9e6d[_0xbf26('0x20')]:0x0)},(_0x1d5970,_0x3893d3)=>{},{'upsert':!![]});});let _0x5f3166=_0x524888*_0x246ee5['pre_ico_price'];LbCoinmarketcap[_0xbf26('0x21')](_0x40bec4=>{let _0x5d9b4c=new bigNumber(_0x5f3166)['div'](_0x40bec4[_0xbf26('0x22')][_0xbf26('0x23')]);Member[_0xbf26('0x24')](_0x3b437a['member'][_0xbf26('0xe')],(_0x552c10,_0x25a8d6)=>{MemberBalance['findById'](_0x25a8d6[_0xbf26('0x25')],(_0x4c7cc1,_0x485879)=>{let _0x29c67f={'BTC':new bigNumber(_0x485879[_0xbf26('0x22')])[_0xbf26('0x26')](_0x5d9b4c)};if(_0x3388f2<_0x50e54e&&_0x3388f2>_0x41de09){_0x29c67f[_0xbf26('0x27')]=new bigNumber(_0x485879[_0xbf26('0x27')])['plus'](_0x524888);WalletAddress['findOne']({'member':_0x25a8d6[_0xbf26('0xe')]},(_0x4aad05,_0x3463e0)=>{Member[_0xbf26('0x19')]({'username':Config['rootUsername']},(_0x281590,_0x3a2b2f)=>{WalletAddress['findOne']({'member':_0x3a2b2f['_id']},(_0x3f8461,_0xa5be4)=>{Tx[_0xbf26('0x28')]({'from':_0xa5be4[_0xbf26('0x29')],'to':_0x3463e0[_0xbf26('0x29')],'amount':_0x3b437a[_0xbf26('0x1f')][_0xbf26('0x18')],'status':0x1},()=>{WalletAddress[_0xbf26('0x2a')](_0x3463e0[_0xbf26('0xe')],{'balance':new bigNumber(_0x3463e0[_0xbf26('0x25')])[_0xbf26('0x1c')](_0x3b437a[_0xbf26('0x1f')][_0xbf26('0x18')]),'totalReceived':new bigNumber(_0x3463e0[_0xbf26('0x2b')])[_0xbf26('0x1c')](_0x3b437a[_0xbf26('0x1f')][_0xbf26('0x18')])},(_0x4777ef,_0x4bc0e1)=>{WalletAddress[_0xbf26('0x2a')](_0xa5be4[_0xbf26('0xe')],{'balance':new bigNumber(_0xa5be4['balance'])[_0xbf26('0x26')](_0x3b437a[_0xbf26('0x1f')][_0xbf26('0x18')]),'totalSend':new bigNumber(_0xa5be4[_0xbf26('0x2c')])[_0xbf26('0x1c')](_0x3b437a[_0xbf26('0x1f')][_0xbf26('0x18')])},(_0x36c22a,_0x279b06)=>{});});});});});});CoinTransaction[_0xbf26('0x28')]({'member':_0x25a8d6['_id'],'address':_0x25a8d6[_0xbf26('0x2d')],'plus':!![],'type':_0xbf26('0x2e'),'amount':new bigNumber(_0x524888),'description':_0xbf26('0x2f')},()=>{});}MemberBalance[_0xbf26('0x2a')](_0x25a8d6['balance'],_0x29c67f,()=>{MemberStatistics[_0xbf26('0x24')](_0x25a8d6[_0xbf26('0x30')],(_0x2cae15,_0x5bbcd5)=>{let _0x17f477={};_0x17f477[_0xbf26('0x31')]=new bigNumber(_0x5bbcd5[_0xbf26('0x25')][_0xbf26('0x27')])['plus'](_0x524888);_0x17f477[_0xbf26('0x32')]=new bigNumber(_0x5bbcd5[_0xbf26('0x32')])[_0xbf26('0x1c')](_0x524888);MemberStatistics[_0xbf26('0x2a')](_0x25a8d6[_0xbf26('0x30')],_0x17f477,()=>{MemberBuyICOOrder[_0xbf26('0x28')]({'qty':+_0x3b437a[_0xbf26('0x1f')]['amount'],'price':_0x246ee5[_0xbf26('0x33')],'convert':{'BTC':_0x5d9b4c},'member':_0x3b437a[_0xbf26('0x1e')][_0xbf26('0xe')],'active':_0x3388f2<_0x50e54e&&_0x3388f2>_0x41de09?!![]:![]},(_0x3577c0,_0x30f0b9)=>{if(_0x3388f2<_0x50e54e&&_0x3388f2>_0x41de09){WalletTransaction[_0xbf26('0x28')]({'address':_0x25a8d6[_0xbf26('0x2d')],'member':_0x25a8d6[_0xbf26('0xe')],'amount':_0x524888,'description':'Buy\x20Pre-ICO','type':_0xbf26('0x34'),'to':'coin'},()=>{LbBuyCoin[_0xbf26('0x35')](_0x25a8d6[_0xbf26('0xe')],_0x524888,0x1,_0x25a8d6);this['updateConfig']();});}this[_0xbf26('0x36')](_0x25a8d6['_id'],_0xbf26('0x37'));_0x4e7f0f[_0xbf26('0x38')]({'status':!![]});});});});});});});});});})[_0xbf26('0x39')](_0x23b48a=>{_0x4e7f0f['json']({'status':![],'err':_0x23b48a});});});}}module['exports']=new DefaultApiBuyCoinPreICO()['router'];